@model WebSite.EndPoint.Areas.Admin.Models.Product.ProductVM
@{
    Layout = "~/Areas/Admin/Views/Shared/_layout.cshtml";
    ViewData["SelectedAdmin"] = "Product";
}
@section CSS
{
    <style>
        .prevImage {
            width: 100%;
            height: 100%;
        }
    </style>
}
<div class="container-fluid">
    <div class="pageName">
        @if (ViewData["CompanyId"] is not null && (long)ViewData["CompanyId"] > 0)
        {
            <span class="textPage">
                <a asp-area="Admin" asp-controller=User asp-action=UserList>
                    لیست کاربران
                </a>
                > @(ViewData["CompanyName"] is not null ? ViewData["CompanyName"] : "") > تعریف/ویرایش محصول
            </span>
        }
        else
        {
            <span class="textPage">
                <a asp-area="Admin" asp-controller="Product" asp-action="ProductList">
                    لیست محصولات
                </a>
                > تعریف/ویرایش محصول
            </span>
        }
    </div>
    @if (ViewData["error"] is not null)
    {
        <div class="row">
            <p style="color:red;">@ViewData["error"].ToString()</p>
        </div>
    }
    <div class="row">
        <a href="#" id="save"><img class="img-Icon" src="~/images/diskette copy.png" /></a>
        @if (ViewData["CompanyId"] is not null && (long)ViewData["CompanyId"] > 0)
        {
            <a href="@Url.Action("CompanyProductList","Product",new{companyId = (long)ViewData["CompanyId"]})" id="cancle"><img class="img-Icon" src="~/images/cancel.png" /></a>
        }
        else
        {
            <a href="@Url.Action("ProductList","Product")" id="cancle"><img class="img-Icon" src="~/images/cancel.png" /></a>
        }
    </div>
    <form id="saveForm" asp-area="Admin" asp-controller="Product" asp-action="Save" enctype="multipart/form-data" method="post">
        @if (ViewData["CompanyId"] is not null && (long)ViewData["CompanyId"] > 0)
        {
            <input hidden name="companyId" value="@((long)ViewData["CompanyId"])" />
        }
        <div class="row">
            <div class="col-md-6">
                <div class="form-group row">
                    <label class="col-sm-3 col-form-label input-Label">گروه اصلی:</label>
                    <div class="col-sm-9">
                        <select id="categories" class="input-text">
                            <option value="0">گروه اصلی را انتخاب کنید</option>
                            @if (Model.Categories != null)
                            {
                                foreach (var item in Model.Categories)
                                {
                                    if (Model.CategoryId == item.Id)
                                    {
                                        <option selected value="@item.Id">@item.Name</option>
                                    }
                                    else
                                    {
                                        <option value="@item.Id">@item.Name</option>
                                    }
                                }
                            }
                        </select>
                    </div>
                </div>
                <div class="form-group row">
                    <label class="col-sm-3 col-form-label input-Label">گروه فرعی:</label>
                    <div class="col-sm-9">
                        <select asp-for="SubCategoryId" disabled id="subCategories" class="input-text">
                        </select>
                        <span class="text-danger" asp-validation-for=SubCategoryId></span>
                    </div>
                </div>
                <div class="form-group row">
                    <label class="col-sm-3 col-form-label input-Label">نام محصول:</label>
                    <div class="col-sm-9">
                        <input asp-for="Name" type="text" class="input-text">
                        <span class="text-danger" asp-validation-for=Name></span>
                    </div>
                </div>
                <div class="form-group row">
                    <label class="col-sm-3 col-form-label input-Label">توضیحات:</label>
                    <div class="col-sm-9">
                        <textarea asp-for="Description" class="input-text"></textarea>
                    </div>
                </div>
                <div class="form-group row">
                    <label class="col-sm-3 col-form-label input-Label">انتخاب تصویر:</label>
                    <div class="col-sm-5 upBtn">
                        <button style="margin-bottom:20px;" type="button" class="btn-submit btnUpload" onclick="getfile()">بارگذاری تصویر</button>
                        <input multiple name="f" id="getFile" style="display:none" class="form-control-file" type="file" accept="image/*">
                    </div>
                    <div id="preview" class="col-sm-2 ShowPic">
                    </div>
                    <input id="isPictureChanged" hidden value="false" name="IsPictureChanged" />
                </div>
                <input hidden asp-for="Id" />
                <input hidden asp-for="CategoryId" />
                <a onclick="addPicture()" id="new"> <img class="img-Icon" src="~/images/addition copy.png" /> </a>
            </div>
        </div>
        <div class="row">
            <table id="myTable" class="display tbStyle">
                <thead>
                    <tr>
                        <th>ردیف</th>
                        <th>تصویر بارگذاری شده</th>
                        <th>حذف</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        if (Model.Pictures != null)
                        {
                            int rowNum = 1;
                            foreach (var item in Model.Pictures)
                            {
                                <tr>
                                    <td class="td-Icon">@(rowNum++)</td>
                                    <td><img class="img img-fluid" src="@item.Rout" style="width:30px;height:30px;" /></td>
                                    <td class="td-Icon"><a href="@Url.Action("DeletePicture","Product",new{pictureId=item.Id,productId=item.ProductId})"><img class="img-Icon" src="~/images/recycle.png" /></a></td>
                                </tr>
                            }
                        }
                    }
                </tbody>
            </table>

        </div>
    </form>
</div>
<img hidden id="deleteIcon" class="img-Icon" src="~/images/recycle.png" />
@section Scripts
{
    <script>

        function getfile () {
            document.querySelector('#getFile').click();
        }

        $('#myTable').DataTable({
            language: {
                "emptyTable": "هیچ داده‌ای در جدول وجود ندارد",
                "info": "نمایش _START_ تا _END_ از _TOTAL_ رکورد",
                "infoEmpty": "نمایش 0 تا 0 از 0 رکورد",
                "infoFiltered": "(فیلتر شده از _MAX_ رکورد)",
                "lengthMenu": "نمایش _MENU_ رکورد در هر صفحه",
                "loadingRecords": "در حال بارگذاری...",
                "processing": "در حال پردازش...",
                "search": "جستجو:",
                "zeroRecords": "رکوردی با این مشخصات پیدا نشد",
                "paginate": {
                    "first": "اولین",
                    "last": "آخرین",
                    "next": "بعدی",
                    "previous": "قبلی"
                },
                "aria": {
                    "sortAscending": ": فعال‌سازی مرتب‌سازی صعودی",
                    "sortDescending": ": فعال‌سازی مرتب‌سازی نزولی"
                }
            }
        });

        var rowCount = @(Model.Pictures != null ? Model.Pictures.Count : 0);
        const fileArray = []; // آرایه برای نگهداری فایل‌ها

        function addPicture()
        {
            const files = $("#getFile")[0].files;

            if (!files || files.length === 0) {
                alert("لطفاً یک تصویر انتخاب کنید!");
                return;
            }

            const deleteIcon = $("#deleteIcon").attr('src');

            Array.from(files).forEach((file)=>{
                const fileIndex = fileArray.length;
                fileArray.push(file); // افزودن فایل به آرایه
                const reader = new FileReader();
                reader.onload = function (e) {
                    if(rowCount===0){
                        $("#myTable tbody").empty();
                    }
                    rowCount++; // افزایش شمارنده ردیف‌ها

                    // ساخت ردیف جدید
                    const newRow = `
                        <tr data-index="${fileIndex}">
                            <td class="td-Icon">${rowCount}</td>
                            <td><img class="img img-fluid" src="${e.target.result}" style="width:30px;height:30px;" /></td>
                            <td class="td-Icon"><a data-index="${fileIndex}" onclick="DeletePic(this)"><img class="img-Icon" src="${deleteIcon}" /></a></td>
                        </tr>
                    `;

                    // اضافه کردن ردیف به جدول
                    $("#myTable tbody").append(newRow);
                };

            // خواندن فایل به صورت URL داده‌ای
                reader.readAsDataURL(file);
            });

        }

        function DeletePic(item){
            const fileIndex = $(item).data("index"); // گرفتن اندیس فایل از دکمه
            fileArray[fileIndex] = null; // حذف فایل از آرایه (با مقدار null)

            // حذف ردیف از جدول
            $(item).closest("tr").remove();
        }

        $("#getFile").on('change',function(){
            const file = this.files[0];

            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    // ایجاد یا جایگزینی تصویر در باکس
                    const img = $("<img>")
                    .attr("src", e.target.result)
                    .addClass("img")
                    .addClass("prevImage");

                    $("#preview").empty().append(img);
                };
                reader.readAsDataURL(file);

                $("#isPictureChanged").val(true);

            } else {
                $("#preview").html("پیش‌نمایش");
            }
        });


        var lastCategoryId=0;

        $("#categories").on('change',function()
        {
            var selectedValue = $(this).val();
            if(selectedValue != lastCategoryId)
            {
                CallAjax(selectedValue,@Model.SubCategoryId);
                lastCategoryId=selectedValue;
            }
        });

        function CallAjax(CategoryId,selectedSubCategory=0){
             $.ajax({
                    url: "/Admin/Product/ChangeCategory", // مسیر اکشن کنترلر
                    type: 'GET',
                    data: {categoryId: CategoryId},
                    dataType: 'json',
                    success: function (data) {
                        $('#subCategories').empty();

                        $('#subCategories').append('<option value="-1">انتخاب کنید</option>');
                        $.each(data, function (index, item) {
                            if(item.id == selectedSubCategory){
                                 $('#subCategories').append('<option selected value="' + item.id + '">' + item.name + '</option>');
                            }
                            else
                            {
                                 $('#subCategories').append('<option value="' + item.id + '">' + item.name + '</option>');
                            }
                        });

                        $("#subCategories").prop('disabled',false);
                    },
                    error: function (xhr, status, err) {
                        console.log(err);
                        $("#subCategories").prop('disabled',true);
                    }
             });
             lastCategoryId=CategoryId;

        }

        $("#save").click(function(event){
            event.preventDefault();
            $("#saveForm").submit();
        });

        $("#saveForm").submit(function () {
            // اضافه کردن فایل‌ها به فرم
            fileArray.forEach((file, index) => {
                if(file!=null)
                {
                    const fileInput = $('<input>')
                    .attr('type', 'file')
                    .attr('name', `PictureFileName`)
                    .addClass('hiddenFileInput');

                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    fileInput[0].files = dataTransfer.files;

                    $(this).append(fileInput);
                }
            });
        });

    </script>

    @if (Model.SubCategoryId > 0)
    {
        <script>
            $(document).ready(function () {
                $("#categories").trigger("change");
            });
        </script>
    }

}